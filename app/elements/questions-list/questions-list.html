<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../question-tag/question-tag.html">


<dom-module id="questions-list">
  <template>
    <style>
      paper-card {
        display: block;
        margin-bottom: 1rem;
      }
    </style>

    <search-box search="{{searchString}}"></search-box>

    <template is="dom-repeat"
      items$="{{computeQuestions(isRandom, randomQuestion.*, questions.*)}}"
      filter="{{searchFilter(searchString)}}"
    >
      <paper-card heading="[[item.question]]">
        <div class="card-content" hidden$="{{computeAdmin(user)}}">[[item.answer]]</div>
        <div class="card-actions" hidden$="{{computeAdmin(user)}}">
          <template is="dom-repeat" items="[[keys(item.tags)]]" as="tag">
            <question-tag>[[tag]]</question-tag>
          </template>
          <question-tag>[[_getLevel(levels, item.level)]]</question-tag>
        </div>
      </paper-card>
    </template>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'questions-list',
      properties: {
        isRandom: {
          type: Boolean,
          value: false
        },
        questions: {
          type: Array,
          value: function() {
            return [];
          },
        },
        randomQuestion: {
          type: Array,
          value: function () {
            return [];
          },
        },
        searchString: {
          type: String,
          notify: true
        },
        levels: Array
      },

      observers: ['_computeRandomQuestion(questions.*)'],

      _computeRandomQuestion: function (changeRecord) {
        if (changeRecord.path === 'questions.length') {
          this.randomQuestion = [ this._getRandomVal(this.questions) ];
        }
      },

      computeAdmin: function(user) {
        return !(!!user.isAdmin);
      },

      _getRandomVal: function (array) {
        return array[Math.floor(Math.random() * array.length)];
      },

      _getLevel: function (levels, level) {
        if (Object.keys(levels).length) {
          return levels[level];
        }
      },

      getRandomQuestion: function () {
        this.randomQuestion = [this._getRandomVal(this.questions)];
      },

      computeQuestions: function (isRandom) {
        if (isRandom) {
          return this.randomQuestion;
        } else {
          return this.questions;
        }
      },
      keys: function(input) {
          return (typeof input === 'object') ? Object.keys(input) : input;
      },
      searchFilter: function(string) {
        if (!string) {
          return null;
        } else {
          string = string.toLowerCase();
          return function(item) {
            var question = item.question.toLowerCase();
            var answer = item.answer.toLowerCase();
            var tags = this.keys(item.tags) || [];
            tags = tags.map(Function.prototype.call, String.prototype.toLowerCase);
            return (question.indexOf(string) !== -1 ||
                answer.indexOf(string) !== -1) ||
                tags.indexOf(string) !== -1;
          }.bind(this);
        }
      }
    });
  })();
  </script>
</dom-module>
